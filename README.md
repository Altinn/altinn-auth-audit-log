# Project Name: Audit Log
## Overview
The audit log component will be responsible for adding logs to the database for authentication and authorization events.

## What is an Authentication Event?
The authenticate event is raised when a user logins into an altinn 3 application.

## What is an Authorization Event?
The authorization event is raised when a user interacts witha an altinn 3 application. F.ex when a user requests permission to instantiate/update an application 

## Architecture
![Image](https://github.com/Altinn/altinn-auth-audit-log/assets/34273718/62fd5fd0-4e59-4249-8ff6-b2492d2c9712)

### Components
The altinn platform cluster is the existing solution that will integrate with the auditlog application.

### 1. Queue
The events generated by the authentication/authorization platform components are queued in authentication/authorization eventlog queues in the azure storage queue.

### 2. Auditlog Function App
The events in the queues are then processed by function application in azure and forwarded to the auditlog container app application. The authentication event processor is reponsible for processing the authentication events and the authorization event processor is reponsible for the authorization events.

### 3. Auditlog Container Application
The auditlog api maps the events to the database model and stores them in the database. The api exposes 2 different endpoints for authentication and authorization.

### 4. Database
The events are stored in the postgres database.

## Technologies
  - .NET [Version]
  - Azure Storage Queue
  - Azure Function App
  - Azure Container App
  - Azure Key Vault
  
## Setup Development Environment

### Prerequisites
The following tools must be installed on the local machine to manage the queue/database/code
 - Visual studio code/visual studio or any code editor
 - [Azure storage explorer](https://azure.microsoft.com/en-us/products/storage/storage-explorer)
 - [Postgres](https://www.postgresql.org/download/)
 - [Pgadmin to manage postgres database](https://www.pgadmin.org/download/)
 - [Azurite as a storage emulator](https://learn.microsoft.com/en-us/azure/storage/common/storage-use-azurite?tabs=visual-studio%2Cblob-storage)

### Configure
AppSettings

Set the workspacepath for the yuniql database. The workspace path is the path where the migration script folder is placed. For ex: 
```
"WorkspacePath": "Altinn.Auth.AuditLog/Migration"
```

Database Setup

Open the pgadmin tool and connect to the local database. Create a database auditlog.

###  Build Auditlog Api
Clone the code from the repository. Build & run the Altinn.Auth.AuditLog.csproj either from the command prompt or IDE.
The database setup or updated when the asp.net core host service starts up. This ensures that database is always at latest compatible state before operating the service.

The auditlog api will be available at
http://localhost:5166/
and the swagger documentation can be accessed at
http://localhost:5166/swagger/index.html

### Verify DB
Verify that auditlog database has the necessary schemas, tables. 

### Test
The api can be tested via postman. 

Endpoint: http://localhost:5166/auditlog/api/v1/authenticationevent

TestData:
```
{
    "created": "2023-06-14T02:39:37",
    "subjectuserid": 20001337,
    "resourcepartyid": 50001337,
    "resource": "app_skd_taxreport",
    "operation": "read",
    "contextrequestjson": "{\"Attributes\":[{\"Id\":null,\"Content\":null,\"Category\":\"urn:oasis:names:tc:xacml:1.0:subject-category:access-subject\",\"Attributes\":[{\"Issuer\":null,\"AttributeId\":\"urn:altinn:userid\",\"AttributeValues\":[{\"Value\":\"20001337\",\"DataType\":\"http://www.w3.org/2001/XMLSchema#string\",\"Elements\":[],\"Attributes\":[]}],\"IncludeInResult\":false}]},{\"Id\":null,\"Content\":null,\"Category\":\"urn:oasis:names:tc:xacml:3.0:attribute-category:action\",\"Attributes\":[{\"Issuer\":null,\"AttributeId\":\"urn:oasis:names:tc:xacml:1.0:action:action-id\",\"AttributeValues\":[{\"Value\":\"read\",\"DataType\":\"http://www.w3.org/2001/XMLSchema#string\",\"Elements\":[],\"Attributes\":[]}],\"IncludeInResult\":false}]},{\"Id\":null,\"Content\":null,\"Category\":\"urn:oasis:names:tc:xacml:3.0:attribute-category:resource\",\"Attributes\":[{\"Issuer\":null,\"AttributeId\":\"urn:altinn:org\",\"AttributeValues\":[{\"Value\":\"org1\",\"DataType\":\"http://www.w3.org/2001/XMLSchema#string\",\"Elements\":[],\"Attributes\":[]}],\"IncludeInResult\":false},{\"Issuer\":null,\"AttributeId\":\"urn:altinn:app\",\"AttributeValues\":[{\"Value\":\"app1\",\"DataType\":\"http://www.w3.org/2001/XMLSchema#string\",\"Elements\":[],\"Attributes\":[]}],\"IncludeInResult\":false},{\"Issuer\":null,\"AttributeId\":\"urn:altinn:partyid\",\"AttributeValues\":[{\"Value\":\"50001337\",\"DataType\":\"http://www.w3.org/2001/XMLSchema#string\",\"Elements\":[],\"Attributes\":[]}],\"IncludeInResult\":false}]}],\"XPathVersion\":null,\"CombinedDecision\":false,\"RequestReferences\":[],\"ReturnPolicyIdList\":false}",
    "decision": "Permit"
}
```

### Build and Run the function application
